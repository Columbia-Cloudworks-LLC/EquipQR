# Migration Repair Script
# This script runs all the migration repair commands from supabase db pull output

$password = "7BRb!wtfioGtNeVp-LczU9kc9!96WvNgY6KTZq4@C3-ajFwsv44TscRuYe*T2osX!"

Write-Host "ğŸ”§ Starting Migration Repair Process..." -ForegroundColor Cyan

# Reverted migrations (exist in production but not locally)
$revertedMigrations = @(
    "20250617025649", "20250617031431", "20250617032743", "20250617033952", "20250617042825",
    "20250617044104", "20250617044455", "20250617044533", "20250617050253", "20250617053540",
    "20250617054725", "20250617055215", "20250621013539", "20250622030200", "20250623023115",
    "20250623025942", "20250623051841", "20250623052623", "20250623060726", "20250624082939",
    "20250624110043", "20250624115935", "20250625031921", "20250702051458", "20250702093903",
    "20250702094019", "20250702094036", "20250702094342", "20250702094746", "20250702101130",
    "20250702101524", "20250702102014", "20250702102713", "20250702103358", "20250705092633",
    "20250705093701", "20250705102310", "20250705103439", "20250705104332", "20250705105755",
    "20250705111655", "20250705112118", "20250706010130", "20250706010620", "20250706020541",
    "20250706021954", "20250706023234", "20250706025336", "20250706025939", "20250706030343",
    "20250706031155", "20250706032236", "20250706034544", "20250706120917", "20250706124046",
    "20250706124908", "20250707075851", "20250707081625", "20250707082829", "20250709040032",
    "20250710043533", "20250710045129", "20250710102733", "20250710103040", "20250710103636",
    "20250711020016", "20250711023219", "20250711031310", "20250718084236", "20250718111936",
    "20250718112628", "20250719010306", "20250719060837", "20250719080150", "20250721031233",
    "20250721034001", "20250724021424", "20250724021451", "20250731083231", "20250731083312",
    "20250731110630", "20250805030254", "20250810101000", "20250810101032", "20250810113836",
    "20250811022118", "20250811022306", "20250811023004", "20250811030522", "20250811031045",
    "20250812093626", "20250812093703", "20250813051529", "20250813051554", "20250813060906",
    "20250813072111", "20250818010810", "20250818015007", "20250818021929", "20250818022137",
    "20250819023827", "20250819113900", "20250822044256", "20250822053659", "20250822065029",
    "20250822074326", "20250822093839", "20250822093922", "20250823045731", "20250825105103",
    "20250825110534"
)

# Applied migrations (exist locally and should be marked as applied)
$appliedMigrations = @(
    "20250616000000", "20250617000000", "20250617044539", "20250617145654", "20250617151439",
    "20250617152746", "20250617153955", "20250617162829", "20250617164108", "20250617164209",
    "20250617164458", "20250617170257", "20250617173544", "20250617174728", "20250617175220",
    "20250621013542", "20250622150202", "20250623060728", "20250623143119", "20250623145949",
    "20250623171845", "20250623172629", "20250624082942", "20250624230047", "20250624235938",
    "20250625151925", "20250702051505", "20250702154230", "20250702213835", "20250702213905",
    "20250702213924", "20250702214023", "20250702214039", "20250702214345", "20250702214748",
    "20250702221133", "20250702221525", "20250702222016", "20250702222715", "20250702223359",
    "20250705212635", "20250705213703", "20250705221652", "20250705222313", "20250705223440",
    "20250705224335", "20250705225757", "20250705231601", "20250705231657", "20250705232121",
    "20250706000920", "20250706003952", "20250706004049", "20250706004910", "20250706010132",
    "20250706010622", "20250706140547", "20250706141956", "20250706143236", "20250706145339",
    "20250706145952", "20250706150346", "20250706151205", "20250706152239", "20250706154548",
    "20250709040035", "20250710043535", "20250710045132", "20250710222736", "20250710223043",
    "20250710223638", "20250711020018", "20250711023221", "20250711031313", "20250718204240",
    "20250718231942", "20250718232637", "20250719010311", "20250719180842", "20250719200155",
    "20250721154006", "20250724021429", "20250724021454", "20250731203236", "20250731203315",
    "20250731230634", "20250805030300", "20250806221920", "20250810101006", "20250810101035",
    "20250810233840", "20250811142054", "20250811142121", "20250811142309", "20250811143009",
    "20250811150525", "20250811151049", "20250812213628", "20250812213706", "20250813051530",
    "20250813051555", "20250813060907", "20250813192112", "20250818010811", "20250818014931",
    "20250818015008", "20250818142144", "20250819143827", "20250819233349", "20250819233905",
    "20250821210541", "20250822044312", "20250822053704", "20250822064942", "20250822065030",
    "20250822212423", "20250822212457", "20250822213626", "20250822213840", "20250822213923",
    "20250825225111", "20250825230539"
)

Write-Host "ğŸ“‹ Processing $($revertedMigrations.Count) reverted migrations..." -ForegroundColor Yellow

$successCount = 0
$errorCount = 0

# Process reverted migrations
foreach ($migration in $revertedMigrations) {
    Write-Host "ğŸ”„ Processing reverted migration: $migration" -ForegroundColor Gray
    try {
        $result = & supabase migration repair --status reverted $migration -p $password 2>&1
        if ($LASTEXITCODE -eq 0) {
            Write-Host "âœ… Success: $migration" -ForegroundColor Green
            $successCount++
        } else {
            Write-Host "âŒ Error: $migration - $result" -ForegroundColor Red
            $errorCount++
        }
    } catch {
        Write-Host "âŒ Exception: $migration - $($_.Exception.Message)" -ForegroundColor Red
        $errorCount++
    }
}

Write-Host "ğŸ“‹ Processing $($appliedMigrations.Count) applied migrations..." -ForegroundColor Yellow

# Process applied migrations  
foreach ($migration in $appliedMigrations) {
    Write-Host "ğŸ”„ Processing applied migration: $migration" -ForegroundColor Gray
    try {
        $result = & supabase migration repair --status applied $migration -p $password 2>&1
        if ($LASTEXITCODE -eq 0) {
            Write-Host "âœ… Success: $migration" -ForegroundColor Green
            $successCount++
        } else {
            Write-Host "âŒ Error: $migration - $result" -ForegroundColor Red
            $errorCount++
        }
    } catch {
        Write-Host "âŒ Exception: $migration - $($_.Exception.Message)" -ForegroundColor Red
        $errorCount++
    }
}

Write-Host "`nğŸ“Š Migration Repair Summary:" -ForegroundColor Cyan
Write-Host "=============================" -ForegroundColor Cyan
Write-Host "âœ… Successful repairs: $successCount" -ForegroundColor Green
Write-Host "âŒ Failed repairs: $errorCount" -ForegroundColor Red
Write-Host "ğŸ“‹ Total processed: $($successCount + $errorCount)" -ForegroundColor Blue

if ($errorCount -eq 0) {
    Write-Host "`nğŸ‰ All migrations repaired successfully!" -ForegroundColor Green
    Write-Host "Next step: Run 'supabase db pull' to get the actual migration files" -ForegroundColor Cyan
} else {
    Write-Host "`nâš ï¸  Some migrations failed. Check the errors above." -ForegroundColor Yellow
}
