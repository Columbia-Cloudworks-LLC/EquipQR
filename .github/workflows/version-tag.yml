name: Auto Version Tag

on:
  push:
    branches: [main]
    paths:
      - 'package.json'

permissions:
  contents: write

jobs:
  tag-version:
    name: Tag Version
    runs-on: ${{ vars.USE_SELF_HOSTED == 'true' && 'self-hosted' || 'ubuntu-latest' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Read version from package.json (Windows)
        if: runner.os == 'Windows'
        id: version_win
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $pkg = Get-Content package.json | ConvertFrom-Json
          $version = $pkg.version
          
          # Check for missing version field
          if (-not $version) {
            Write-Host "âŒ Missing version field in package.json"
            exit 1
          }
          
          # Validate version format (semver: x.y.z)
          if (-not ($version -match '^\d+\.\d+\.\d+$')) {
            Write-Host "âŒ Invalid version format: $version"
            Write-Host "Version must match pattern: x.y.z (e.g., 1.0.0, 2.1.3)"
            exit 1
          }
          
          $tag = "v$version"
          "version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "tag=$tag" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          Write-Host "ðŸ“¦ Version from package.json: $version"
          Write-Host "ðŸ·ï¸  Tag to create: $tag"

      - name: Read version from package.json (Unix)
        if: runner.os != 'Windows'
        id: version
        shell: bash
        run: |
          VERSION=$(node -p "require('./package.json').version")
          
          # Check for missing version field
          if [ -z "$VERSION" ] || [ "$VERSION" = "undefined" ] || [ "$VERSION" = "null" ]; then
            echo "âŒ Missing version field in package.json"
            exit 1
          fi
          
          # Validate version format (semver: x.y.z)
          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ Invalid version format: $VERSION"
            echo "Version must match pattern: x.y.z (e.g., 1.0.0, 2.1.3)"
            exit 1
          fi
          
          TAG="v$VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Version from package.json: $VERSION"
          echo "ðŸ·ï¸  Tag to create: $TAG"

      - name: Check if tag exists (Windows)
        if: runner.os == 'Windows'
        id: check-tag-win
        shell: pwsh
        run: |
          $tag = "${{ steps.version_win.outputs.tag }}"
          git fetch --tags --force
          if (git rev-parse "$tag" 2>$null) {
            "exists=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            Write-Host "âœ… Tag $tag already exists, skipping tag creation"
          } else {
            "exists=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            Write-Host "ðŸ†• Tag $tag does not exist, will create it"
          }

      - name: Check if tag exists (Unix)
        if: runner.os != 'Windows'
        id: check-tag
        shell: bash
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          git fetch --tags --force
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âœ… Tag $TAG already exists, skipping tag creation"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "ðŸ†• Tag $TAG does not exist, will create it"
          fi

      - name: Create and push tag (Windows)
        if: runner.os == 'Windows' && steps.check-tag-win.outputs.exists == 'false'
        shell: pwsh
        run: |
          $tag = "${{ steps.version_win.outputs.tag }}"
          $version = "${{ steps.version_win.outputs.version }}"
          
          Write-Host "ðŸ·ï¸  Creating tag: $tag"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git tag -a "$tag" -m "Release v$version"
          
          Write-Host "ðŸ“¤ Pushing tag to origin..."
          git push origin "$tag"
          Write-Host "âœ… Successfully created and pushed tag: $tag"

      - name: Create and push tag (Unix)
        if: runner.os != 'Windows' && steps.check-tag.outputs.exists == 'false'
        shell: bash
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          VERSION="${{ steps.version.outputs.version }}"
          
          echo "ðŸ·ï¸  Creating tag: $TAG"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git tag -a "$TAG" -m "Release v$VERSION"
          
          echo "ðŸ“¤ Pushing tag to origin..."
          git push origin "$TAG"
          echo "âœ… Successfully created and pushed tag: $TAG"

      - name: Summary (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $version = "${{ steps.version_win.outputs.version }}"
          $tag = "${{ steps.version_win.outputs.tag }}"
          $exists = "${{ steps.check-tag-win.outputs.exists }}"
          
          "## Version Tagging Summary" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          "**Version:** ``$version``" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          "**Tag:** ``$tag``" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          if ($exists -eq "true") {
            "**Status:** Tag already exists, no action taken" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          } else {
            "**Status:** Tag created and pushed successfully" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          }

      - name: Summary (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG="${{ steps.version.outputs.tag }}"
          EXISTS="${{ steps.check-tag.outputs.exists }}"
          
          echo "## Version Tagging Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`$VERSION\`" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** \`$TAG\`" >> $GITHUB_STEP_SUMMARY
          if [ "$EXISTS" = "true" ]; then
            echo "**Status:** Tag already exists, no action taken" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status:** Tag created and pushed successfully" >> $GITHUB_STEP_SUMMARY
          fi

