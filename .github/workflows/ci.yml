name: Continuous Integration

on:
  pull_request:
    branches: [ main, preview ]
  push:
    branches: [ main, preview ]

permissions:
  contents: read
  security-events: write
  pull-requests: write
  checks: write

env:
  NODE_VERSION: 20.x
  CACHE_VERSION: v1

jobs:
  lint-and-typecheck:
    name: Lint & Type Check
    runs-on: ${{ vars.USE_SELF_HOSTED == 'true' && 'self-hosted' || 'ubuntu-latest' }}
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.npm
          node_modules
        key: ${{ runner.os }}-node-${{ env.NODE_VERSION }}-${{ env.CACHE_VERSION }}-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-${{ env.NODE_VERSION }}-${{ env.CACHE_VERSION }}-
          
    - name: Enforce npm usage (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        if ((Test-Path "yarn.lock") -or (Test-Path "pnpm-lock.yaml")) {
          Write-Host "Detected non-npm lockfile. This project uses npm only."
          exit 1
        }

    - name: Enforce npm usage (Unix)
      if: runner.os != 'Windows'
      shell: bash
      run: |
        if [ -f "yarn.lock" ] || [ -f "pnpm-lock.yaml" ]; then
          echo "Detected non-npm lockfile. This project uses npm only."
          exit 1
        fi
        
    - name: Install dependencies (with fallback) (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        $ErrorActionPreference = 'Stop'
        try {
          npm ci --prefer-offline --no-audit
        } catch {
          if (Test-Path "package-lock.json") { Remove-Item "package-lock.json" -Force }
          npm install --package-lock-only --no-audit
          npm ci --prefer-offline --no-audit
        }

    - name: Install dependencies (with fallback) (Unix)
      if: runner.os != 'Windows'
      shell: bash
      run: |
        set -e
        npm ci --prefer-offline --no-audit || (rm -f package-lock.json && npm install --package-lock-only --no-audit && npm ci --prefer-offline --no-audit)

    - name: Run ESLint
      run: npx eslint . --format=json --output-file=eslint-report.json
      continue-on-error: true
      
    - name: Annotate ESLint Results
      uses: ataylorme/eslint-annotate-action@v3
      if: always()
      with:
        GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
        report-json: "eslint-report.json"
        
    - name: Run type check
      run: npx tsc --noEmit

  test:
    name: Test Suite
    runs-on: ${{ vars.USE_SELF_HOSTED == 'true' && 'self-hosted' || 'ubuntu-latest' }}
    timeout-minutes: 15
    
    strategy:
      matrix:
        # Node 18.x dropped: bin-links@6.0.0 requires node ^20.17.0 || >=22.9.0
        node-version: [20.x, 22.x]
        
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.npm
          node_modules
        key: ${{ runner.os }}-node-${{ matrix.node-version }}-${{ env.CACHE_VERSION }}-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-${{ matrix.node-version }}-${{ env.CACHE_VERSION }}-
          
    - name: Enforce npm usage (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        if ((Test-Path "yarn.lock") -or (Test-Path "pnpm-lock.yaml")) {
          Write-Host "Detected non-npm lockfile. This project uses npm only."
          exit 1
        }

    - name: Enforce npm usage (Unix)
      if: runner.os != 'Windows'
      shell: bash
      run: |
        if [ -f "yarn.lock" ] || [ -f "pnpm-lock.yaml" ]; then
          echo "Detected non-npm lockfile. This project uses npm only."
          exit 1
        fi
        
    - name: Install dependencies (with fallback) (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        $ErrorActionPreference = 'Stop'
        try {
          npm ci --prefer-offline --no-audit
        } catch {
          if (Test-Path "package-lock.json") { Remove-Item "package-lock.json" -Force }
          npm install --package-lock-only --no-audit
          npm ci --prefer-offline --no-audit
        }

    - name: Install dependencies (with fallback) (Unix)
      if: runner.os != 'Windows'
      shell: bash
      run: |
        set -e
        npm ci --prefer-offline --no-audit || (rm -f package-lock.json && npm install --package-lock-only --no-audit && npm ci --prefer-offline --no-audit)

    - name: Run tests with coverage
      run: node scripts/test-ci.mjs
      env:
        # Note: CI uses istanbul provider which reports ~15-20% lower than v8 (local)
        COVERAGE_BASELINE: 51
        VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
        VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
        
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      if: matrix.node-version == '20.x'
      with:
        file: ./coverage/lcov.info
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
        token: ${{ secrets.CODECOV_TOKEN }}

    - name: Upload coverage artifacts for PR report
      uses: actions/upload-artifact@v4
      if: matrix.node-version == '20.x' && github.event_name == 'pull_request'
      with:
        name: coverage-report
        path: |
          coverage/coverage-summary.json
          coverage/coverage-final.json
        retention-days: 1

  # Posts coverage report as PR comment
  report-coverage:
    name: Coverage Report
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download coverage artifacts
      uses: actions/download-artifact@v4
      with:
        name: coverage-report
        path: coverage

    - name: Post coverage report
      uses: davelosert/vitest-coverage-report-action@v2
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        json-summary-path: coverage/coverage-summary.json
        json-final-path: coverage/coverage-final.json
        vite-config-path: vitest.config.ts
        comment-on: pr

  security:
    name: Security Scan
    runs-on: ubuntu-latest  # Keep security scans on GitHub-hosted for isolation
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.npm
          node_modules
        key: ${{ runner.os }}-node-${{ env.NODE_VERSION }}-${{ env.CACHE_VERSION }}-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-${{ env.NODE_VERSION }}-${{ env.CACHE_VERSION }}-
          
    - name: Enforce npm usage
      run: |
        if [ -f "yarn.lock" ] || [ -f "pnpm-lock.yaml" ]; then
          echo "Detected non-npm lockfile. This project uses npm only."
          exit 1
        fi
        
    - name: Install dependencies (with fallback)
      run: |
        set -e
        npm ci --prefer-offline --no-audit || (rm -f package-lock.json && npm install --package-lock-only --no-audit && npm ci --prefer-offline --no-audit)

    - name: Run enhanced security audit
      run: npx npm-audit-ci --moderate
      continue-on-error: true
      
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: javascript
        queries: security-and-quality
        
    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      with:
        category: "/language:javascript"

  build:
    name: Build & Bundle Analysis
    runs-on: ${{ vars.USE_SELF_HOSTED == 'true' && 'self-hosted' || 'ubuntu-latest' }}
    timeout-minutes: 15
    needs: [lint-and-typecheck]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.npm
          node_modules
        key: ${{ runner.os }}-node-${{ env.NODE_VERSION }}-${{ env.CACHE_VERSION }}-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-${{ env.NODE_VERSION }}-${{ env.CACHE_VERSION }}-
          
    - name: Enforce npm usage (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        if ((Test-Path "yarn.lock") -or (Test-Path "pnpm-lock.yaml")) {
          Write-Host "Detected non-npm lockfile. This project uses npm only."
          exit 1
        }

    - name: Enforce npm usage (Unix)
      if: runner.os != 'Windows'
      shell: bash
      run: |
        if [ -f "yarn.lock" ] || [ -f "pnpm-lock.yaml" ]; then
          echo "Detected non-npm lockfile. This project uses npm only."
          exit 1
        fi
        
    - name: Install dependencies (with fallback) (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        $ErrorActionPreference = 'Stop'
        try {
          npm ci --prefer-offline --no-audit
        } catch {
          if (Test-Path "package-lock.json") { Remove-Item "package-lock.json" -Force }
          npm install --package-lock-only --no-audit
          npm ci --prefer-offline --no-audit
        }

    - name: Install dependencies (with fallback) (Unix)
      if: runner.os != 'Windows'
      shell: bash
      run: |
        set -e
        npm ci --prefer-offline --no-audit || (rm -f package-lock.json && npm install --package-lock-only --no-audit && npm ci --prefer-offline --no-audit)

    - name: Cache build output
      uses: actions/cache@v4
      with:
        path: dist
        key: ${{ runner.os }}-build-${{ github.sha }}
        
    - name: Read app version from package.json (Windows)
      if: runner.os == 'Windows'
      id: ver_win
      shell: pwsh
      run: |
        $ErrorActionPreference = 'Stop'
        $pkg = Get-Content package.json | ConvertFrom-Json
        $appVersion = $pkg.version
        if ([string]::IsNullOrWhiteSpace($appVersion)) {
          Write-Host "‚ùå Missing version field in package.json"
          exit 1
        }
        # Validate version format (semver: x.y.z)
        if (-not ($appVersion -match '^\d+\.\d+\.\d+$')) {
          Write-Host "‚ùå Invalid version format: $appVersion"
          Write-Host "Version must match pattern: x.y.z (e.g., 1.0.0, 2.1.3)"
          exit 1
        }
        "APP_VERSION=$appVersion" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        "APP_VERSION=$appVersion" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
        Write-Host "üìä Version Information:"
        Write-Host "  App version (from package.json): $appVersion"

    - name: Read app version from package.json (Unix)
      if: runner.os != 'Windows'
      id: ver
      shell: bash
      run: |
        APP_VERSION=$(node -p "require('./package.json').version")
        if [ -z "$APP_VERSION" ] || [ "$APP_VERSION" = "undefined" ] || [ "$APP_VERSION" = "null" ]; then
          echo "‚ùå Missing version field in package.json"
          exit 1
        fi
        # Validate version format (semver: x.y.z)
        if ! [[ "$APP_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo "‚ùå Invalid version format: $APP_VERSION"
          echo "Version must match pattern: x.y.z (e.g., 1.0.0, 2.1.3)"
          exit 1
        fi
        echo "APP_VERSION=$APP_VERSION" >> $GITHUB_ENV
        echo "APP_VERSION=$APP_VERSION" >> $GITHUB_OUTPUT
        echo "üìä Version Information:"
        echo "  App version (from package.json): $APP_VERSION"

    - name: Export public env for Vite (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        "VITE_APP_VERSION=$env:APP_VERSION" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

    - name: Export public env for Vite (Unix)
      if: runner.os != 'Windows'
      shell: bash
      run: echo "VITE_APP_VERSION=${APP_VERSION}" >> $GITHUB_ENV

    - name: Build application
      run: npm run build
      env:
        VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
        VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
        VITE_APP_VERSION: ${{ env.VITE_APP_VERSION }}
        
    - name: Analyze bundle size
      run: npx size-limit --json || echo "Size limit check completed with warnings"
      continue-on-error: true
      timeout-minutes: 5
      
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-files
        path: dist/
        retention-days: 7

  quality-gates:
    name: Quality Gates
    runs-on: ${{ vars.USE_SELF_HOSTED == 'true' && 'self-hosted' || 'ubuntu-latest' }}
    needs: [test, security, build]
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.npm
          node_modules
        key: ${{ runner.os }}-node-${{ env.NODE_VERSION }}-${{ env.CACHE_VERSION }}-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-${{ env.NODE_VERSION }}-${{ env.CACHE_VERSION }}-
          
    - name: Enforce npm usage (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        if ((Test-Path "yarn.lock") -or (Test-Path "pnpm-lock.yaml")) {
          Write-Host "Detected non-npm lockfile. This project uses npm only."
          exit 1
        }

    - name: Enforce npm usage (Unix)
      if: runner.os != 'Windows'
      shell: bash
      run: |
        if [ -f "yarn.lock" ] || [ -f "pnpm-lock.yaml" ]; then
          echo "Detected non-npm lockfile. This project uses npm only."
          exit 1
        fi
        
    - name: Install dependencies (with fallback) (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        $ErrorActionPreference = 'Stop'
        try {
          npm ci --prefer-offline --no-audit
        } catch {
          if (Test-Path "package-lock.json") { Remove-Item "package-lock.json" -Force }
          npm install --package-lock-only --no-audit
          npm ci --prefer-offline --no-audit
        }

    - name: Install dependencies (with fallback) (Unix)
      if: runner.os != 'Windows'
      shell: bash
      run: |
        set -e
        npm ci --prefer-offline --no-audit || (rm -f package-lock.json && npm install --package-lock-only --no-audit && npm ci --prefer-offline --no-audit)

    - name: Restore build cache
      uses: actions/cache@v4
      with:
        path: dist
        key: ${{ runner.os }}-build-${{ github.sha }}
        
    # Note: Test coverage is already validated in the Test Suite job.
    # Quality Gates validates build artifacts and bundle sizes only.
        
    - name: Check bundle size limits (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        if (-not (Test-Path "dist")) {
          Write-Host "Build directory not found, running build..."
          npm run build
        }
        $buildSize = (Get-ChildItem -Path dist -Recurse -File | Measure-Object -Property Length -Sum).Sum
        $maxSize = 12MB
        Write-Host "Build size: {0:N2}MB" -f ($buildSize/1MB)
        Write-Host "Maximum allowed: 12MB"
        if ($buildSize -gt $maxSize) {
          Write-Host "‚ùå Build size {0:N2}MB exceeds maximum of 12MB" -f ($buildSize/1MB)
          Write-Host "Large files in build (>1MB):"
          Get-ChildItem -Path dist -Recurse -File | Where-Object { $_.Length -gt 1MB } | Sort-Object Length -Descending | Select-Object -First 10 | ForEach-Object { "{0:N2}MB `t {1}" -f ($_.Length/1MB), $_.FullName }
          exit 1
        }
        Write-Host "‚úÖ Build size within limits!"

    - name: Check bundle size limits (Unix)
      if: runner.os != 'Windows'
      shell: bash
      run: |
        if [ ! -d "dist" ]; then
          echo "Build directory not found, running build..."
          npm run build
        fi
        
        build_size=$(du -sb dist/ | cut -f1)
        max_size=$((12 * 1024 * 1024)) # 12MB in bytes
        
        echo "Build size: $(($build_size / 1024 / 1024))MB"
        echo "Maximum allowed: $(($max_size / 1024 / 1024))MB"
        
        if [ $build_size -gt $max_size ]; then
          echo "‚ùå Build size $(($build_size / 1024 / 1024))MB exceeds maximum of $(($max_size / 1024 / 1024))MB"
          echo "Large files in build:"
          find dist/ -type f -size +1M -exec du -sh {} \; | sort -hr | head -10
          exit 1
        fi
        echo "‚úÖ Build size within limits!"
      env:
        VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
        VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
        
    - name: Performance budget check (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        Write-Host "üìä Performance Analysis:"
        Write-Host "JavaScript bundles:"
        Get-ChildItem dist/assets -Filter *.js -Recurse | Sort-Object Length -Descending | Select-Object -First 5 | ForEach-Object { "{0:N2}MB `t {1}" -f ($_.Length/1MB), $_.FullName }
        Write-Host "CSS bundles:"
        Get-ChildItem dist/assets -Filter *.css -Recurse | Sort-Object Length -Descending | Select-Object -First 3 | ForEach-Object { "{0:N2}MB `t {1}" -f ($_.Length/1MB), $_.FullName }
        Write-Host "Images:"
        $imgCount = (Get-ChildItem dist -Include *.png,*.jpg,*.svg -Recurse -File | Measure-Object).Count
        Write-Host "Image count: $imgCount"

    - name: Performance budget check (Unix)
      if: runner.os != 'Windows'
      shell: bash
      run: |
        echo "üìä Performance Analysis:"
        echo "JavaScript bundles:"
        find dist/assets -name "*.js" -exec du -sh {} \; | sort -hr | awk 'NR<=5'
        echo "CSS bundles:"
        find dist/assets -name "*.css" -exec du -sh {} \; | sort -hr | awk 'NR<=3'
        echo "Images:"
        find dist -type f \( -name "*.png" -o -name "*.jpg" -o -name "*.svg" \) | wc -l | xargs echo "Image count:"
        
    - name: Check gzipped JS bundle sizes (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        if (-not (Test-Path "dist")) {
          Write-Host "Build directory not found, running build..."
          npm run build
        }
        Write-Host "üì¶ Checking gzipped JavaScript bundle sizes:"
        $maxGzipSize = 512000
        $failed = $false
        Add-Type -AssemblyName System.IO.Compression.FileSystem
        function Get-GzipSizeBytes([string]$filePath) {
          $bytes = [System.IO.File]::ReadAllBytes($filePath)
          $outStream = New-Object System.IO.MemoryStream
          $gzip = New-Object System.IO.Compression.GZipStream($outStream, [System.IO.Compression.CompressionLevel]::Optimal)
          $gzip.Write($bytes, 0, $bytes.Length)
          $gzip.Dispose()
          $size = $outStream.Length
          $outStream.Dispose()
          return [int]$size
        }
        Get-ChildItem dist/assets -Filter *.js -File | ForEach-Object {
          $gzipSize = Get-GzipSizeBytes $_.FullName
          $sizeKB = [math]::Floor($gzipSize / 1024)
          Write-Host "  $($_.Name): ${sizeKB}KB (gzipped)"
          if ($gzipSize -gt $maxGzipSize) {
            Write-Host "::error file=$($_.FullName)::Gzipped JS bundle $($_.Name) (${sizeKB}KB) exceeds 500KB limit"
            $failed = $true
          }
        }
        if ($failed) {
          Write-Host "‚ùå One or more JS bundles exceed the 500KB gzipped size limit"
          exit 1
        }
        Write-Host "‚úÖ All JS bundles within 500KB gzipped limit"

    - name: Check gzipped JS bundle sizes (Unix)
      if: runner.os != 'Windows'
      shell: bash
      run: |
        if [ ! -d "dist" ]; then
          echo "Build directory not found, running build..."
          npm run build
        fi
        
        echo "üì¶ Checking gzipped JavaScript bundle sizes:"
        max_gzip_size=512000 # 500KB in bytes
        failed=false
        
        for js_file in dist/assets/*.js; do
          if [ -f "$js_file" ]; then
            gzip_size=$(gzip -c "$js_file" | wc -c)
            size_kb=$((gzip_size / 1024))
            filename=$(basename "$js_file")
            
            echo "  $filename: ${size_kb}KB (gzipped)"
            
            if [ $gzip_size -gt $max_gzip_size ]; then
              echo "::error file=$js_file::Gzipped JS bundle $filename (${size_kb}KB) exceeds 500KB limit"
              failed=true
            fi
          fi
        done
        
        if [ "$failed" = true ]; then
          echo "‚ùå One or more JS bundles exceed the 500KB gzipped size limit"
          exit 1
        fi
        echo "‚úÖ All JS bundles within 500KB gzipped limit"
      env:
        VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
        VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
        
    - name: Success notification
      run: |
        echo "üéâ All quality gates passed!"
        echo "‚úÖ Linting and type checking passed"
        echo "‚úÖ All tests passed with sufficient coverage" 
        echo "‚úÖ Security scan completed"
        echo "‚úÖ Build completed successfully"
        echo "‚úÖ Bundle size within limits"