name: Deploy to Vercel

on:
  push:
    branches: [main, preview]

permissions:
  contents: read

jobs:
  notify-deployment:
    name: Notify Deployment
    runs-on: ${{ vars.USE_SELF_HOSTED == 'true' && 'self-hosted' || 'ubuntu-latest' }}
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/preview'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get version from package.json (Windows)
        if: runner.os == 'Windows'
        id: version_win
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $pkg = Get-Content package.json | ConvertFrom-Json
          $version = $pkg.version
          if ([string]::IsNullOrWhiteSpace($version)) {
            Write-Host "âŒ Missing version field in package.json"
            exit 1
          }
          # Validate version format (semver: x.y.z)
          if (-not ($version -match '^\d+\.\d+\.\d+$')) {
            Write-Host "âŒ Invalid version format: $version"
            Write-Host "Version must match pattern: x.y.z (e.g., 1.0.0, 2.1.3)"
            exit 1
          }
          $tag = "v$version"
          "version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "tag=$tag" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Get version from package.json (Unix)
        if: runner.os != 'Windows'
        id: version
        shell: bash
        run: |
          VERSION=$(node -p "require('./package.json').version")
          if [ -z "$VERSION" ] || [ "$VERSION" = "undefined" ] || [ "$VERSION" = "null" ]; then
            echo "âŒ Missing version field in package.json"
            exit 1
          fi
          # Validate version format (semver: x.y.z)
          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ Invalid version format: $VERSION"
            echo "Version must match pattern: x.y.z (e.g., 1.0.0, 2.1.3)"
            exit 1
          fi
          TAG="v$VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Deployment notification (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Write-Host "ðŸš€ Deployment triggered for $env:GITHUB_REF_NAME branch"
          Write-Host "Version: ${{ steps.version_win.outputs.version }}"
          $envName = if ($env:GITHUB_REF -eq 'refs/heads/main') { 'production' } else { 'preview' }
          Write-Host "Environment: $envName"
          Write-Host "Vercel will handle the actual deployment automatically"
          Write-Host ""
          Write-Host "Expected URLs:"
          if ($env:GITHUB_REF -eq 'refs/heads/main') {
            Write-Host "  Production: https://equipqr.app"
          } else {
            Write-Host "  Preview: https://preview.equipqr.app"
          }

      - name: Deployment notification (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          echo "ðŸš€ Deployment triggered for ${{ github.ref_name }} branch"
          echo "Version: ${{ steps.version.outputs.version }}"
          echo "Environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'preview' }}"
          echo "Vercel will handle the actual deployment automatically"
          echo ""
          echo "Expected URLs:"
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "  Production: https://equipqr.app"
          else
            echo "  Preview: https://preview.equipqr.app"
          fi

